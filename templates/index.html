<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Agent Deal Closer</title>
    <style>
        body { font-family: sans-serif; margin: 2em; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; vertical-align: middle; }
        th { background-color: #f2f2f2; }
        button, .edit-btn, .save-btn { background-color: #0070d2; color: white; padding: 5px 10px; border: none; cursor: pointer; border-radius: 4px; font-size: 12px; }
        .edit-btn { background-color: #555; }
        .email-input { padding: 4px; width: 95%; }
        .edit-mode { display: none; }
        /* --- All other styles (spinner, toast) remain the same --- */
        #spinner-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; display: none; justify-content: center; align-items: center; }
        .spinner { border: 8px solid #f3f3f3; border-top: 8px solid #0070d2; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #toast { visibility: hidden; min-width: 250px; background-color: #4CAF50; color: white; text-align: center; border-radius: 2px; padding: 16px; position: fixed; z-index: 1001; left: 50%; transform: translateX(-50%); top: 30px; }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 4.5s; }
        @keyframes fadein { from {top: 0; opacity: 0;} to {top: 30px; opacity: 1;} }
        @keyframes fadeout { from {top: 30px; opacity: 1;} to {top: 0; opacity: 0;} }
    </style>
</head>
<body>
    <h1>Opportunities Ready to Close</h1>
    <form id="deal-form">
        <table>
            <thead>
                <tr>
                    <th>Select</th>
                    <th>Opportunity ID</th>
                    <th>Opportunity Name</th>
                    <th>Amount</th>
                    <th>Primary Contact Name</th>
                    <th>Primary Contact Email</th>
                    <th>Close Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for opp in opportunities %}
                <tr data-contact-id="{{ opp.PrimaryContactId }}">
                    <td>
                        <input type="checkbox" name="opportunity_ids" value="{{ opp.Id }}" {% if opp.PrimaryContactEmail == 'N/A' %}disabled{% endif %}>
                    </td>
                    <td>{{ opp.Id }}</td>
                    <td>{{ opp.Name }}</td>
                    <td>${{ opp.Amount }}</td>
                    <td>{{ opp.PrimaryContactName }}</td>
                    <td>
                        <div class="view-mode">
                            <span class="email-text">{{ opp.PrimaryContactEmail }}</span>
                        </div>
                        <div class="edit-mode">
                            <input type="email" class="email-input" value="{{ opp.PrimaryContactEmail }}">
                        </div>
                    </td>
                    <td>{{ opp.CloseDate }}</td>
                    <td>
                        <div class="view-mode">
                             <button type="button" class="edit-btn" onclick="editEmail(this)" {% if opp.PrimaryContactEmail == 'N/A' %}disabled{% endif %}>Edit</button>
                        </div>
                        <div class="edit-mode">
                            <button type="button" class="save-btn" onclick="saveEmail(this)">Save</button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <br>
        <button type="submit">Start Closing Selected Deals</button>
    </form>
    
    <div id="spinner-overlay"><div class="spinner"></div></div>
    <div id="toast">Envelopes are sent and waiting for signature from primary contacts.</div>

    <script>
        // This part for the form submission remains the same
        const form = document.getElementById('deal-form');
        const spinner = document.getElementById('spinner-overlay');
        const toast = document.getElementById('toast');
        form.addEventListener('submit', function(event) { /* ... your existing spinner/toast logic ... */ });

        // --- CORRECTED JAVASCRIPT FUNCTIONS ---

        function editEmail(editButton) {
            const row = editButton.closest('tr');
            // Select ALL view-mode elements in the row and hide them
            row.querySelectorAll('.view-mode').forEach(el => el.style.display = 'none');
            // Select ALL edit-mode elements in the row and show them
            row.querySelectorAll('.edit-mode').forEach(el => el.style.display = 'block');
        }

        function saveEmail(saveButton) {
            const row = saveButton.closest('tr');
            const contactId = row.dataset.contactId;
            const emailInput = row.querySelector('.email-input');
            const newEmail = emailInput.value;

            fetch('/update-contact', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contact_id: contactId, new_email: newEmail })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    row.querySelector('.email-text').textContent = newEmail;
                    // Switch back to view mode for ALL elements
                    row.querySelectorAll('.view-mode').forEach(el => el.style.display = 'block');
                    row.querySelectorAll('.edit-mode').forEach(el => el.style.display = 'none');
                } else {
                    alert('Error saving email: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please check the console.');
            });
        }
    </script>
</body>
</html>