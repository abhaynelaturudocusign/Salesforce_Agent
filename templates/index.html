<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>The Closer</title>
    <style>
        body { font-family: sans-serif; margin: 2em; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; vertical-align: middle; }
        th { background-color: #f2f2f2; }
        button, .edit-btn, .save-btn { background-color: #0070d2; color: white; padding: 5px 10px; border: none; cursor: pointer; border-radius: 4px; font-size: 12px; }
        .edit-btn { background-color: #555; }
        .email-input { padding: 4px; width: 95%; }
        .edit-mode { display: none; }
        #spinner-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; display: none; justify-content: center; align-items: center; }
        .spinner { border: 8px solid #f3f3f3; border-top: 8px solid #0070d2; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #toast { visibility: hidden; min-width: 250px; background-color: #4CAF50; color: white; text-align: center; border-radius: 2px; padding: 16px; position: fixed; z-index: 1001; left: 50%; transform: translateX(-50%); top: 30px; }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 4.5s; }
        @keyframes fadein { from {top: 0; opacity: 0;} to {top: 30px; opacity: 1;} }
        @keyframes fadeout { from {top: 30px; opacity: 1;} to {top: 0; opacity: 0;} }
    </style>
</head>
<body>
    <h1>The Closer</h1>
    <h2>Select the opportunites and ask the closer agent to close</h2>
    <form id="deal-form">
        <table>
            <thead>
                <tr>
                    <th>Select</th>
                    <th>Opportunity ID</th>
                    <th>Opportunity Name</th>
                    <th>Amount</th>
                    <th>Primary Contact Name</th>
                    <th>Primary Contact Email</th>
                    <th>Close Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for opp in opportunities %}
                <tr data-contact-id="{{ opp.PrimaryContactId }}">
                    <td>
                        <input type="checkbox" name="opportunity_ids" value="{{ opp.Id }}" {% if opp.PrimaryContactEmail == 'N/A' %}disabled{% endif %}>
                    </td>
                    <td>{{ opp.Id }}</td>
                    <td>{{ opp.Name }}</td>
                    <td>${{ opp.Amount }}</td>
                    <td>{{ opp.PrimaryContactName }}</td>
                    <td>
                        <div class="view-mode">
                            <span class="email-text">{{ opp.PrimaryContactEmail }}</span>
                        </div>
                        <div class="edit-mode">
                            <input type="email" class="email-input" value="{{ opp.PrimaryContactEmail }}">
                        </div>
                    </td>
                    <td>{{ opp.CloseDate }}</td>
                    <td>
                        <div class="view-mode">
                             <button type="button" class="edit-btn" onclick="editEmail(this)" {% if opp.PrimaryContactEmail == 'N/A' %}disabled{% endif %}>Edit</button>
                        </div>
                        <div class="edit-mode">
                            <button type="button" class="save-btn" onclick="saveEmail(this)">Save</button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <br>
        <button type="submit" formnovalidate>Start Closing Selected Deals</button>
    </form>
    
    <div id="spinner-overlay"><div class="spinner"></div></div>
    <div id="toast">Envelopes are sent and waiting for signature from primary contacts.</div>

    <script>
        const form = document.getElementById('deal-form');
        const spinner = document.getElementById('spinner-overlay');
        const toast = document.getElementById('toast');

        // Logic for the main "Start Closing" button
        form.addEventListener('submit', function(event) {
            event.preventDefault();
            spinner.style.display = 'flex';
            const formData = new FormData(form);

            fetch('/start-closing', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.task_id) {
                    pollStatus(data.task_id);
                } else {
                    spinner.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                spinner.style.display = 'none';
            });
        });

        // Logic for the polling status check
        function pollStatus(taskId) {
            const intervalId = setInterval(() => {
                fetch(`/task-status/${taskId}`)
                    .then(response => response.json())
                    .then(data => {
                        console.log(`Completed: ${data.completed}/${data.total}`);
                        if (data.status === 'completed') {
                            clearInterval(intervalId);
                            spinner.style.display = 'none';
                            toast.className = 'show';
                            setTimeout(() => { toast.className = toast.className.replace('show', ''); }, 5000);
                        }
                    })
                    .catch(error => {
                        console.error('Polling Error:', error);
                        clearInterval(intervalId);
                        spinner.style.display = 'none';
                    });
            }, 3000);
        }

        // --- Logic for the inline "Edit" and "Save" buttons ---
        function editEmail(editButton) {
            const row = editButton.closest('tr');
            row.querySelectorAll('.view-mode').forEach(el => el.style.display = 'none');
            row.querySelectorAll('.edit-mode').forEach(el => el.style.display = 'block');
        }

        function saveEmail(saveButton) {
            const row = saveButton.closest('tr');
            const contactId = row.dataset.contactId;
            const emailInput = row.querySelector('.email-input');
            const newEmail = emailInput.value;

            fetch('/update-contact', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contact_id: contactId, new_email: newEmail })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    row.querySelector('.email-text').textContent = newEmail;
                    row.querySelectorAll('.view-mode').forEach(el => el.style.display = 'block');
                    row.querySelectorAll('.edit-mode').forEach(el => el.style.display = 'none');
                } else {
                    alert('Error saving email: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please check the console.');
            });
        }
    </script>
</body>
</html>